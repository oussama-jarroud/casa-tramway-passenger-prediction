{% extends "base.html" %}
{% load static %}

{% block title %}Upload et Pr√©diction{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üöã Pr√©diction de la Fr√©quentation du Tramway de Casablanca</h1>
        <p>Uploadez un fichier CSV contenant une colonne <b>'Date'</b> (et optionnellement <b>'Nb_Passagers'</b>) pour g√©n√©rer des pr√©dictions.</p>
    </div>

    <div class="form-section">
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <form id="upload-form" method="post" enctype="multipart/form-data" class="upload-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="csv_file">üìÇ S√©lectionnez votre fichier CSV :</label>
                <input type="file" name="csv_file" id="csv_file" accept=".csv" required>
            </div>

            <div class="form-group">
                <label for="model_choice">üß† Choisissez le mod√®le de pr√©diction :</label>
                <select name="model_choice" id="model_choice">
                    <option value="XGBoost" {% if model_used == "XGBoost" %}selected{% endif %}>XGBoost</option>
                    <option value="Random Forest" {% if model_used == "Random Forest" %}selected{% endif %}>Random Forest</option>
                    <option value="Linear Regression" {% if model_used == "Linear Regression" %}selected{% endif %}>Linear Regression</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">üöÄ Lancer la Pr√©diction</button>
        </form>

        <div id="loading" style="display: none; text-align:center; margin-top:20px;">
            <p>‚è≥ Traitement en cours... Veuillez patienter.</p>
        </div>
    </div>

    {% if predictions_df %}
        <div class="results-section">
            <h2>üìä R√©sultats de la Pr√©diction (Mod√®le : {{ model_used }})</h2>
            <div class="alert-success">‚úÖ Pr√©diction termin√©e avec succ√®s !</div>

            <div class="table-responsive">
                {{ predictions_df|safe }}
            </div>

            <div id="predictionChart" style="height: 500px; width: 100%;"></div>

            <script>
                const chartData = JSON.parse('{{ chart_data_json|escapejs }}');
                const dates = chartData.map(item => item.Date);
                const actuals = chartData.map(item => item.Passagers_Reels);
                const predictions = chartData.map(item => item.Predictions);

                const trace1 = {
                    x: dates,
                    y: actuals,
                    mode: 'lines',
                    name: 'Passagers R√©els',
                    line: {color: 'blue'}
                };

                const trace2 = {
                    x: dates,
                    y: predictions,
                    mode: 'lines',
                    name: 'Pr√©dictions',
                    line: {color: 'red', dash: 'dash'}
                };

                const layout = {
                    title: '√âvolution des Passagers (R√©els vs Pr√©dictions)',
                    xaxis: { title: 'Date', type: 'date' },
                    yaxis: { title: 'Nombre de Passagers' },
                    hovermode: 'x unified'
                };

                Plotly.newPlot('predictionChart', [trace1, trace2], layout);
            </script>
        </div>
    {% elif history_data_json %}
        <div class="initial-chart">
            <h2>üìà Donn√©es Historiques (Exemple)</h2>
            <div id="historyChart" style="height: 500px; width: 100%;"></div>
            <script>
                const historyData = JSON.parse('{{ history_data_json|escapejs }}');
                const datesHistory = historyData.map(item => item.Date);
                const actualsHistory = historyData.map(item => item.Passagers_Reels);

                const traceHistory = {
                    x: datesHistory,
                    y: actualsHistory,
                    mode: 'lines',
                    name: 'Passagers Historiques',
                    line: {color: 'green'}
                };

                const layoutHistory = {
                    title: 'Donn√©es Historiques des Passagers',
                    xaxis: { title: 'Date', type: 'date' },
                    yaxis: { title: 'Nombre de Passagers' }
                };

                Plotly.newPlot('historyChart', [traceHistory], layoutHistory);
            </script>
        </div>
    {% endif %}
</div>

<script>
    // Affiche un message de chargement pendant le traitement
    document.getElementById('upload-form').addEventListener('submit', function() {
        document.getElementById('loading').style.display = 'block';
    });
</script>
{% endblock %}
